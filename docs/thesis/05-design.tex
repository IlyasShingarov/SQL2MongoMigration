\chapter{Конструкторский раздел}
В данном разделе представлены результаты разработки метода миграции данных 
из реляционной в документо-ориентированную базу данных 
с использованием частотного и семантического анализа.
Представлены используемые алгоритмы, описаны входные и выходные данные.
Описан процесс преобразования схемы из реляционной в документо-ориентированную.
Выполнено проектирование для программной реализации метода с
использованием функциональной модели IDEF0 и схем алгоритмов.

\section{Описание метода миграции данных}
Входными данными являются:
\begin{enumerate}
    \item Реляционная схема.
    \item Статистика запросов к СУБД.
    \item Информация о предметной области.
    \item Данные реляционной БД.
\end{enumerate}

В ходе работы метода происходит сбор метаданных о таблицах РСУБД, 
таких как названия таблиц, первичные и внешние ключи, столбцы и типы данных.
Далее эти метаданные дополняются результатами частотного анализа JOIN-операций, 
засчет того, что связи между сущностями помечаются как <<часто объединяемые>>. 
На основе сформированных метаданных, 
засчет семантического анализа происходит формирование JSON-cхемы, 
как промежуточного представления данных в документо-ориентированной БД.
Согласно сформированной схеме, производится перенос данных из реляционной в документо-ориентированную БД.

Выходными данныи являются:
\begin{enumerate}
    \item Данные в документо-ориентированной БД.
\end{enumerate}
\clearpage

\includeimage{diploma-A1-A4}{f}{h}{\textwidth}{Подпись}

% \clearpage

\section{Описание алгоритма получения метаданных о реляционной схеме}

Реляционные СУБД хранят информацию о созданных в них таблицах в отдельной схеме, 
которая называется information\_schema и является частью стандарта ANSI [?].
Данные о таблицах, их столбцах и ключах хранятся в виде информационных таблиц и представлений, 
что позволяет поддержание стандарта SQL, тем самым позволяет использовать предлагаемый инструментарий в большинстве РСУБД.
Многие СУБД также предоставляют собственные дополнительные инструменты для получения метаданных, например, системные каталоги,
но они прориетарны для каждой системы управления базами данных и не портируемы.

В первую очередь необходимо собрать спиок интересующих нас таблиц.
Далее, для каждой из этих таблиц нужно получить информацию о названиях столбцов, типах данных и ключах.
Информация о ключах и связях между таблицами является наиболее важной, 
поэтому необходимо получить не только список первичных и внешних ключей в каждой таблице, но и внешние ключи, 
которые ссылаются на интересующие нас таблицы.
Таким образом мы получаем не только исходящие но и входящие связи.

В результате сбора метаданных мы получаем список структур, каждая из которых хранит метаданные для одной таблицы.

\noindentСтруктуры имеют вид:
\begin{itemize}[label=---]
    \item название таблицы;
    \item список столбцов; 
    % \begin{itemize}
    %     \item название столбца;
    %     \item название типа данных;
    %     \item наличие ограничение на null;
    % \end{itemize}

    \item список первичных ключей;
    \item список внешних ключей;
    \item список исходящих связей таблицы;
    \item список входящих связей таблицы;
\end{itemize}

Собранные метаданные служат основой для семантического анализа схемы, 
который позволяет предварительно определить отношения между таблицами для 
дальнейшего выбора метода переноса связи из реляционной в документо-ориентированную модель.

Тем не менее, метаданные не содержат достаточно информации для организации процесса миграции, 
так как информация о кратности отношений и интересущих нас таблицах зависит от особенностей предметной области
и не может быть определена без данных от пользователя.

На рисунке \ref{img:diploma-metadata-collection} представлен алгоритм сбора метаданных о таблицах базы данных.

\includeimage{diploma-metadata-collection}{f}{h}{0.22\textwidth}{Алгоритм сбора метаданных таблиц реляционной базы данных.}


\clearpage


\section{Описание алгоритма частотного анализа JOIN-операций}
Большинство современных РСУБД предоставляют возможность логирования и сбора статистики о работе СУБД.
Этот инструментарий может быть использован для анализа запросов к базе данных.

История запросов к СУБД обрабатывается, 
для определения частоты совершения JOIN-операций между двумя таблицами.
Если таблица участвует в JOIN-операции значительно чаще чем в SELECT,
можно предположить, что данные в зависимой таблице не востребованны отдельно от основной, 
поэтому она выдвигается как кандидиат для пометки как <<часто объединяемая>>.

На основе этх данных, <<часто объединяемые>> таблицы рекомендуются к предаггрегации.
Таким образом в документо-ориентированной модели их отношение будет реализовано засчет вложенных документов.

\clearpage

На рисунке \ref{img:diploma-frequency-analysis} представлен алгоритм дополнения метаданных результатами частотного анализа.
\includeimage{diploma-frequency-analysis}
    {f}
    {h}
    {0.22\textwidth}
{Алгоритм дополнения метаданных результатами частотного анализа.}

\clearpage
На рисунке \ref{img:diploma-frequency-process} представлен алгоритм анализа истории запросов к базе данных.
\includeimage{diploma-frequency-process}
    {f}
    {h}
    {0.611\textwidth}
{Алгоритм анализа истории запросов.}

\clearpage

\section{Описание алгоритма преобразования схемы}
После сбора и предобработки метаданных следует преобразовать реляционную схему в документо-ориентированную JSON-схему.
Происходит выбор таблиц, на основе которых будут созданы коллекции документов в документо-ориентированной СУБД.
Далее для каждой таблицы, на основе собранных метаданных с использованием информации о предметной области и семантического анализа формируется JSON-документ,
который будет отражать вид данных в документо-ориентированной БД.
Все неключевые столбцы таблицы преобразуются в JSON-атрибуты. 
Первичный ключ заменяется идентификатором объекта.
После чего для каждого внешнего ключа предлагается набор действий в зависимости от имеющейся информации.
Зависимые таблицы либо встраиваются в основной документ, либо создается ссылка на идентификатор из другой коллекции.

На рисунке \ref{img:diploma-schema-transformation} представлен алгоритм преобразования реляционной схемы в JSON-схему.

\includeimage{diploma-schema-transformation}
    {f}
    {h}
    {0.45\textwidth}
{Алгоритм преобразования схемы.}

\clearpage

На рисунке \ref{img:diploma-get-transformation} представлен алгоритм определения типа преобразования.

\includeimage{diploma-get-transformation}
    {f}
    {h}
    {0.6\textwidth}
{Алгоритм определения типа преобразования.}



\clearpage

\section{Алгоритм преобразования данных в формат JSON}
Сформированная схема используется для последующего преобразования данных.
Согласно метаданным и сформированной схеме, 
данные реляционной БД выгружаются и каждая запись преобразуется в эквивалентный JSON-документ согласно схеме,
после чего сформированный документ выгружается в целевую документо-ориентированную БД.

\includeimage{diploma-data-transfer}
    {f}
    {h}
    {0.15\textwidth}
{Алгоритм преобразования данных.}

\clearpage

\section*{Выводы}
В данном разделе были описаны результаты разработки
метода миграции данных из реляционной в документо-ориентированную базу данных
с использованием семантического и частотного анализа.
Были представлены используемые алгоритмы, описаны входные и выходные данные.
Выполнено проектирование для дальнейшей программной реализации метода при помощи 
функциональной модели IDEF0 и схем алгоритмов.
