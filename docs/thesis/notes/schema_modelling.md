# Schema modelling

## Что нужно учитывать при создании схемы
* Каким образом данные используются в системе
* Каких операций больше? Чтения или записи?
* К каким данныи наиболее часто обращаются совместно?

## Особенности вложенности документов
* CRUD операции над одним документом соответствуют ACID
* Можем единоразово получить все необходимые данные
* Имеется ограничение в 16Мб на один документ

## Особенности ссылок на документы
* Документы меньше
* Нечасто запрашиваемая информация не затрагивается при запросе
* Позволяет избежать дупликации данных
* Необходимо использовать `$lookup` для объединения документов при получении информации

## Отношения
### Один-к-одному
**Один-к-одному** -- встроенный документ. Не имеет смысла создавать ссылку, т.к. данные напрямую связаны между собой.

### Один-к-нескольким
При отношении **один-к-нескольким** предпочтительно встраивание массива, т.к. мы заранее знаем, что размер массива ограничен и документ не превысит ограничение в 16Мб.

```json
{
    "_id": "ObjectId('AAA')",
    "name": "Joe Karlsson",
    "company": "MongoDB",
    "twitter": "@JoeKarlsson1",
    "twitch": "joe_karlsson",
    "tiktok": "joekarlsson",
    "website": "joekarlsson.com",
    "addresses": [
        { "street": "123 Sesame St", "city": "Anytown", "cc": "USA" },  
        { "street": "123 Avenue Q",  "city": "New York", "cc": "USA" }
    ]
}
```

### Один-к-многим
Отношение **один-к-многим** предполгает, что количество зависимых данных может быть большим и не ограничено.
Также в случаях, если часто происходят обращения к членам отношения независимо -- создается ссылка или же массив ссылок.

```json
{ // Products
    "name": "left-handed smoke shifter",
    "manufacturer": "Acme Corp",
    "catalog_number": "1234",
    "parts": ["ObjectID('AAAA')", "ObjectID('BBBB')", "ObjectID('CCCC')"]
}
{ // Parts
    "_id" : "ObjectID('AAAA')",
    "partno" : "123-aff-456",
    "name" : "#4 grommet",
    "qty": "94",
    "cost": "0.94",
    "price":" 3.99"
}
```

### Один-к-ОЧЕНЬ-многим
В случае если никаких ограничений на рост зависимых частей нет, необходимо переформатировать схему.
В таком случае, проще будет хранить в каждом зависимом документе ссылку на главный, чтобы размер главного документа не разросся.


------

* Подключаемся к базе данных
* Получаем список таблиц в схеме
* Запрашиваем таблицы, на основе которых будут созданы коллекции
* Для каждой выбранной таблицы
  * Определяем все отношения
  * Уточняем отношения
  * На основе отношений и статистических данных принимаем решение
    * Embed
    * Reference
  * Рекурсивно
  * Формируем промежуточную схему
* По промежуточной схеме формируем JSON схему
* Согласно сформированной схеме выгружаем данные

-------